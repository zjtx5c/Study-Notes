## 推荐系统（精摘）

直接看这位作者整理的[笔记](https://zhuanlan.zhihu.com/p/678664853)更省力

### 概要

#### 01：推荐系统的基本概念

> 这节课以小红书为例，讲解推荐系统的基本概念，包括： 
>
> 用户行为：点击、点赞、收藏、转发
>
> 消费指标：点击率 (click rate)、交互率 (engagement rate) 
>
> 北极星指标：用户规模、消费、发布
>
> 实验流程：离线实验、AB测试、推全

* 北极星指标
  * 是线上指标不是离线指标

* 优质内容池是社交平台（比如小红书）的核心竞争力。

* 算法工程师的工作就是对模型特征策略系统做改进，提升各种**指标**
  * 流程：离线实验——小流量AB测试——全流量上线



#### 02：推荐系统链路

> 这节课以小红书为例讲解推荐系统的链路。链路包括召回、粗排、精排、重排。 
>
> 召回（retrieval）：快速从海量数据中取回几千个用户可能感兴趣的物品。
>
> 粗排：用小规模的模型的神经网络给召回的物品打分，然后做截断，选出分数最高的几百个物品。
>
> 精排：用大规模神经网络给粗排选中的几百个物品打分，可以做截断，也可以不做截断。
>
> 重排：对精排结果做多样性抽样，得到几十个物品，然后用规则调整物品的排序。

* 把排序分为粗排与精排是为了解决计算量过大的问题，这是从效率的角度考虑的
  * 粗排是小模型但是处理的数据量巨大
  * 精排处理的数据量小但是模型很复杂（用的特征更多）
  * 这种设计确实通过**分层处理**实现了效率与效果的权衡：粗排确保系统响应速度，精排保障推荐质量。实际应用中还需根据业务场景调整阶段划分和模型复杂度。
  * 重排其实是做多样性抽样。抽样有两个依据：1. 精排分数大小；2. 多样性；抽样结束后，用一定的规则来打散相似笔记；还要插入广告、运营推广等内容。（很复杂，数千行代码）
* 模型的输入包括**用户特征**、**物品特征**以及**统计特征**



#### 03：推荐系统的AB测试

> 推荐系统算法工程师的日常工作就是改进模型和策略，目标是提升推荐系统的业务指标。所有对模型和策略的改进，都需要经过线上 AB 测试，用实验数据来验证模型和策略是否有效。这节课介绍工业界AB测试的一些基本概念。 
>
> 1. 分层实验，同层互斥，不同层正交，这样可以同时开很多实验。 
> 2. Holdout 机制用于衡量整个部门的业务指标收益。 
> 3. 实验推全、反转实验的基本思想。

* 离线效果≠在线效果

  * 需做**小流量**的 A/B 测试，考察对线上指标的影响
  * A/B测试可以选取模型中的最优参数

* 随机分桶

  * 针对每个桶分别设计多个实验组（每个组中模型的参数不一样） + 对照组

* 分层实验

  * 同层互斥、不同层正交
  * 理解**互斥与正交**，这样能提高效率

* Holdout 机制

  * 用来观察业绩
  * 比如保留 10% 的用户，完全不受实验影响，可以考察整个部门对业务指标的贡献

* 实验推全&反转实验

  * 新建一个推全层，与其他层正交。推全意味着扩大/覆盖到90%的流量上

  * 反转实验：在新的推全层上，保留一个小的反转桶，使用旧策略。长期观测新旧策略的 `diff`。

    



## 技术（精摘）

只记录一些“灵光一现”的重点，稍微点一下，具体了解还得去看原文。

### 召回模型

#### 基于协同过滤的召回

基于用户与基于物品

协同过滤的优点就是没有使用更多的用户或者物品属性信息，仅利用用户和物品之间的交互信息就能完成推荐，该算法简单高效；但这也是协同过滤算法的一个弊端。由于未使用更丰富的用户和物品特征信息，这也导致协同过滤算法的模型表达能力有限。

##### UserCF

* 三种相似度的计算方法
  * `Jaccard` 系数
    * Jaccard 相似度表示两个集合的交集元素个数在并集中所占的比例 ，所以适用于隐式反馈数据（0-1数据，二元型，表示未发生与发生），反映用户行为的间接偏好
  * 余弦相似度
    * 从向量的角度描述，使用了可达**矩阵**
    * 既然是矩阵，那么就难免有稀疏性、计算开销大的特点
  * 皮尔逊相关系数
    * 皮尔逊相关系数与余弦相似度很像，感觉就像是一个做了中心性调整（即对评分做了修正，减少了用户评分偏置的影响）的余弦相似度
* 理解代码使用字典与数组存储数据的优劣

##### ItemCF

ItemCF算法并不利用**物品的内容属性**计算物品之间的相似度， 主要通过分析**用户的行为记录**计算物品之间的相似度。

也即根据大批量、大规模的用户购买的用户记录来度量物品之间的相似度

* 逐步理解协同过滤算法的权重改进

  主要是考虑更好地处理**热门物品与活跃用户（度数/互动次数极高的用户）**，因为若物品 $j$ 为热门物品，那么直觉上它与任何物品的相似度都很高，活跃用户同理。

  * base公式
  * 对热门物品进行惩罚
  * 控制对热门物品的惩罚力度
  * 对活跃用户的惩罚

* 为什么对于异常活跃的用户，在计算物品之间的相似度时，他的贡献应该小于非活跃用户。

  在推荐系统或社交网络分析中，**异常活跃用户**（即度数/互动次数极高的用户）对物品相似度计算的贡献应该小于**非活跃用户**，主要原因包括以下几点：  

  1. **异常活跃用户的连接通常信息量较低**  

        - **活跃用户可能与几乎所有物品/用户都有交互**，比如：
          - 在电商平台，某些用户会给几乎所有商品都打高分（评分膨胀）。
          - 在社交网络，某些大V会关注/被关注成千上万人，但并不能反映真实的兴趣相似性。  

        - 这些用户的交互行为**噪声大、信号弱**，不能很好地反映物品之间的真实关联。  

        - **非活跃用户**的行为通常更聚焦，他们的共同交互更能反映物品的真实相似性。  


  2. **活跃用户的共同交互可能只是偶然的，而非真实关联**  

        - 如果两个物品都被一个异常活跃用户交互过（比如购买/点击），这可能只是因为这个用户**行为广泛**，而非这两个物品真的相似。  

        - 相比之下，如果两个物品都被**多个低活跃度用户**共同交互，则更可能说明它们有真实的关联（比如同一小众兴趣群体都喜欢它们）。  


  3. **活跃用户会主导相似度计算，导致流行度偏差（Popularity Bias）**  

        - 如果不降权，活跃用户的交互会主导相似度计算，导致：
          - 热门物品（被大量活跃用户交互过的）会与其他热门物品显得相似（即使它们无关）。  
          - 长尾物品（被少数用户交互）的相似度被淹没，难以被发现。  

        - **降权活跃用户**可以缓解这一问题，使推荐结果更加多样化。  


  4. **数学角度：活跃用户的相似度贡献应该被平滑**  
        - 通过 $\log{N_u + 1}$ 进行平滑


  **总结：为什么降权异常活跃用户？**  

  | **情况**         | **贡献** | **原因**                                             |
  | ---------------- | -------- | ---------------------------------------------------- |
  | **异常活跃用户** | 贡献小   | 行为**噪声大**，连接**信息量低**，容易导致流行度偏差 |
  | **非活跃用户**   | 贡献大   | 行为更聚焦，共同交互更能反映真实关联                 |

  这种降权策略在推荐系统（如UserCF、ItemCF）、链接预测（如Adamic-Adar指标）中广泛使用，以提高相似度计算的准确性。

* 协同过滤算法的问题分析
  * 泛化能力弱
    * **CF 的相似性计算是局部的、基于已有共现数据的，无法像人类或更高级的模型那样进行==逻辑推理或泛化。==**，因为这里相似性计算的策略完全依赖于共现数据（即用户行为的重叠），而**没有建模物品本身的属性或潜在关系**。
  * 协同过滤的天然缺陷：
    * **推荐系统头部效应明显**，冷启动
    * **处理稀疏向量的能力弱**，会导致不冷不热的商品与其他不冷不热的商品交互数据太稀疏，缺乏相似性计算的直接数据（区分不出来）。
